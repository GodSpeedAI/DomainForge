<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SEA DSL WASM Browser Example</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    h1 {
      color: #333;
      border-bottom: 2px solid #4CAF50;
      padding-bottom: 10px;
    }
    .container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-top: 20px;
    }
    .panel {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .panel h2 {
      margin-top: 0;
      color: #4CAF50;
      font-size: 1.2em;
    }
    textarea {
      width: 100%;
      min-height: 300px;
      padding: 10px;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      border: 1px solid #ddd;
      border-radius: 4px;
      resize: vertical;
    }
    button {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin-top: 10px;
      transition: background 0.3s;
    }
    button:hover {
      background: #45a049;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .output {
      background: #f9f9f9;
      padding: 15px;
      border-radius: 4px;
      border: 1px solid #e0e0e0;
      margin-top: 10px;
      min-height: 100px;
      max-height: 400px;
      overflow-y: auto;
    }
    pre {
      margin: 0;
      white-space: pre-wrap;
      word-wrap: break-word;
      font-family: 'Courier New', monospace;
      font-size: 13px;
    }
    .stats {
      display: flex;
      gap: 20px;
      margin: 10px 0;
    }
    .stat {
      flex: 1;
      background: #e8f5e9;
      padding: 10px;
      border-radius: 4px;
      text-align: center;
    }
    .stat-value {
      font-size: 24px;
      font-weight: bold;
      color: #2e7d32;
    }
    .stat-label {
      font-size: 12px;
      color: #666;
      text-transform: uppercase;
    }
    .error {
      color: #d32f2f;
      background: #ffebee;
      padding: 10px;
      border-radius: 4px;
      margin-top: 10px;
    }
    .success {
      color: #2e7d32;
      background: #e8f5e9;
      padding: 10px;
      border-radius: 4px;
      margin-top: 10px;
    }
    .loading {
      color: #1976d2;
      font-style: italic;
    }
  </style>
</head>
<body>
  <h1>ðŸ§­ SEA DSL WebAssembly Browser Demo</h1>

  <div class="container">
    <div class="panel">
      <h2>Input: SEA DSL Code</h2>
      <textarea id="input" placeholder="Enter SEA DSL code here...">Entity "Warehouse" in logistics
Entity "Factory" in manufacturing
Entity "Store" in retail

Resource "Cameras" units
Resource "Steel" kg

Flow "Cameras" from "Warehouse" to "Factory" quantity 100
Flow "Cameras" from "Factory" to "Store" quantity 80
Flow "Steel" from "Warehouse" to "Factory" quantity 500</textarea>
      <button id="parseBtn" onclick="parseAndAnalyze()">Parse & Analyze</button>
      <button id="buildBtn" onclick="buildProgrammatically()">Build Programmatically</button>
    </div>

    <div class="panel">
      <h2>Output: Analysis Results</h2>
      <div class="stats" id="stats" style="display: none;">
        <div class="stat">
          <div class="stat-value" id="entityCount">0</div>
          <div class="stat-label">Entities</div>
        </div>
        <div class="stat">
          <div class="stat-value" id="resourceCount">0</div>
          <div class="stat-label">Resources</div>
        </div>
        <div class="stat">
          <div class="stat-value" id="flowCount">0</div>
          <div class="stat-label">Flows</div>
        </div>
        <div class="stat">
          <div class="stat-value" id="instanceCount">0</div>
          <div class="stat-label">Instances</div>
        </div>
      </div>
      <div class="output" id="output">
        <p class="loading">Ready to parse. Click "Parse & Analyze" or "Build Programmatically".</p>
      </div>
    </div>
  </div>

  <script type="module">
    import { Graph, Entity, Resource, Flow, preloadWasm } from '../pkg/index.js';

    // HTML escaping utility
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    let wasmReady = false;

    async function initialize() {
      // Show loading indicator and disable buttons
      const output = document.getElementById('output');
      const parseBtn = document.getElementById('parseBtn');
      const buildBtn = document.getElementById('buildBtn');

      output.innerHTML = '<div class="loading">Loading WASM module...</div>';
      parseBtn.disabled = true;
      buildBtn.disabled = true;

      try {
        await preloadWasm();
        wasmReady = true;
        console.log('WASM module loaded successfully');
        output.innerHTML = '<p class="loading">Ready to parse. Click "Parse & Analyze" or "Build Programmatically".</p>';
        parseBtn.disabled = false;
        buildBtn.disabled = false;
      } catch (error) {
        console.error('Failed to load WASM:', error);
        output.innerHTML =
          `<div class="error">Failed to load WASM module: ${escapeHtml(error?.message ?? String(error))}</div>`;
        // Keep buttons disabled on error
      }
    }

    // Initialize asynchronously
    (async () => {
      await initialize();
    })();
      if (!wasmReady) {
        document.getElementById('output').innerHTML =
          '<div class="error">WASM module not ready. Please wait...</div>';
        return;
      }

      const input = document.getElementById('input').value;
      const output = document.getElementById('output');
      const parseBtn = document.getElementById('parseBtn');

      parseBtn.disabled = true;
      output.innerHTML = '<p class="loading">Parsing...</p>';

      try {
        const graph = await Graph.parse(input);

        const entityCount = graph.entityCount();
        const resourceCount = graph.resourceCount();
        const flowCount = graph.flowCount();
        const instanceCount = graph.instanceCount();

        document.getElementById('entityCount').textContent = entityCount;
        document.getElementById('resourceCount').textContent = resourceCount;
        document.getElementById('flowCount').textContent = flowCount;
        document.getElementById('instanceCount').textContent = instanceCount;
        document.getElementById('stats').style.display = 'flex';

        let result = '<div class="success">âœ“ Parsing successful!</div>';

        result += '<h3>Graph Structure:</h3>';
        const graphJson = graph.toJSON();
        result += `<pre>${JSON.stringify(graphJson, null, 2)}</pre>`;

        if (entityCount > 0) {
          result += '<h3>Entities:</h3>';
          const entities = graph.allEntities();
          entities.forEach(entity => {
            const ns = entity.namespace ? ` (namespace: ${escapeHtml(entity.namespace)})` : '';
            result += `<p>â€¢ <strong>${escapeHtml(entity.name)}</strong>${ns}<br>ID: ${entity.id}</p>`;
          });
        }

        if (resourceCount > 0) {
          result += '<h3>Resources:</h3>';
          const resources = graph.allResources();
          resources.forEach(resource => {
            result += `<p>â€¢ <strong>${escapeHtml(resource.name)}</strong> (${escapeHtml(resource.unit)})<br>ID: ${resource.id}</p>`;
          });
        }

        if (flowCount > 0) {
          result += '<h3>Flows:</h3>';
          const flows = graph.allFlows();
          flows.forEach(flow => {
            const fromEntity = graph.getEntity(flow.fromId);
            const toEntity = graph.getEntity(flow.toId);
            const resource = graph.getResource(flow.resourceId);
            result += `<p>â€¢ ${flow.quantity} ${resource ? escapeHtml(resource.unit) : 'units'} of <strong>${resource ? escapeHtml(resource.name) : 'unknown'}</strong><br>`;
            result += `  From: ${fromEntity ? escapeHtml(fromEntity.name) : 'unknown'} â†’ To: ${toEntity ? escapeHtml(toEntity.name) : 'unknown'}</p>`;
          });
        }

        output.innerHTML = result;
      } catch (error) {
        output.innerHTML = `<div class="error"><strong>Parse Error:</strong><br>${escapeHtml(error?.message ?? String(error))}</div>`;
        document.getElementById('stats').style.display = 'none';
      } finally {
        parseBtn.disabled = false;
      }
    };

    window.buildProgrammatically = async function() {
      if (!wasmReady) {
        document.getElementById('output').innerHTML =
          '<div class="error">WASM module not ready. Please wait...</div>';
        return;
      }

      const output = document.getElementById('output');
      const buildBtn = document.getElementById('buildBtn');

      buildBtn.disabled = true;
      output.innerHTML = '<p class="loading">Building graph...</p>';

      try {
        const graph = new Graph();

        const warehouse = new Entity('Warehouse', 'logistics');
        const factory = new Entity('Factory', 'manufacturing');
        const store = new Entity('Store', 'retail');

        await graph.addEntity(warehouse);
        await graph.addEntity(factory);
        await graph.addEntity(store);

        const cameras = new Resource('Cameras', 'units', null);
        const steel = new Resource('Steel', 'kg', null);

        await graph.addResource(cameras);
        await graph.addResource(steel);

        const flow1 = new Flow(cameras.id, warehouse.id, factory.id, '100');
        const flow2 = new Flow(cameras.id, factory.id, store.id, '80');
        const flow3 = new Flow(steel.id, warehouse.id, factory.id, '500');

        await graph.addFlow(flow1);
        await graph.addFlow(flow2);
        await graph.addFlow(flow3);

        document.getElementById('entityCount').textContent = graph.entityCount();
        document.getElementById('resourceCount').textContent = graph.resourceCount();
        document.getElementById('flowCount').textContent = graph.flowCount();
        document.getElementById('instanceCount').textContent = graph.instanceCount();
        document.getElementById('stats').style.display = 'flex';

        let result = '<div class="success">âœ“ Graph built successfully!</div>';
        result += '<h3>Programmatically Created:</h3>';
        result += `<p>â€¢ 3 Entities: Warehouse, Factory, Store</p>`;
        result += `<p>â€¢ 2 Resources: Cameras (units), Steel (kg)</p>`;
        result += `<p>â€¢ 3 Flows:</p>`;
        result += `<ul>
          <li>100 units of Cameras: Warehouse â†’ Factory</li>
          <li>80 units of Cameras: Factory â†’ Store</li>
          <li>500 kg of Steel: Warehouse â†’ Factory</li>
        </ul>`;

        result += '<h3>Graph Traversal Example:</h3>';
        const warehouseFlows = await graph.flowsFrom(warehouse.id);
        result += `<p>Flows from Warehouse: ${warehouseFlows.length}</p>`;

        const factoryUpstream = await graph.upstreamEntities(factory.id);
        result += `<p>Upstream entities of Factory: ${factoryUpstream.map(e => escapeHtml(e.name)).join(', ')}</p>`;

        const factoryDownstream = await graph.downstreamEntities(factory.id);
        result += `<p>Downstream entities of Factory: ${factoryDownstream.map(e => escapeHtml(e.name)).join(', ')}</p>`;

        result += '<h3>Complete Graph JSON:</h3>';
        const graphJson = graph.toJSON();
        result += `<pre>${JSON.stringify(graphJson, null, 2)}</pre>`;

        output.innerHTML = result;
      } catch (error) {
        output.innerHTML = `<div class="error"><strong>Build Error:</strong><br>${escapeHtml(error?.message ?? String(error))}</div>`;
        document.getElementById('stats').style.display = 'none';
      } finally {
        buildBtn.disabled = false;
      }
    };

    // Initialize asynchronously
    (async () => {
      await initialize();
    })();
  </script>
</body>
</html>
