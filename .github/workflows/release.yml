name: Release

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., v0.4.1). Leave empty to use current version from Cargo.toml.'
        required: false
        type: string
      dry_run:
        description: 'Dry run (build but do not publish)'
        required: false
        type: boolean
        default: false

permissions:
  contents: write

env:
  CACHE_VERSION: v3
  WASM_MAX_BYTES: "2097152" # 2MB - harmonized with ci.yml
  CLI_MAX_BYTES: "52428800" # 50MB
  CLI_ARTIFACT_MAX_BYTES: "73400320" # 70MB

jobs:
  build-release:
    name: Build Release (${{ matrix.target }})
    strategy:
      fail-fast: false
      matrix:
        include:
          # x86_64 targets
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
          - target: x86_64-apple-darwin
            os: macos-14  # macos-13 retired Dec 2024
          - target: x86_64-pc-windows-msvc
            os: windows-latest
          # ARM targets
          - target: aarch64-apple-darwin
            os: macos-14  # Apple Silicon runner
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-latest
            use_cross: true
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install cross (for ARM Linux)
        if: matrix.use_cross == true
        run: cargo install cross --locked

      - name: Install just
        uses: extractions/setup-just@v2

      - name: Build release binary (native)
        if: matrix.use_cross != true
        run: cargo build --release --target ${{ matrix.target }} --features cli
        working-directory: sea-core

      - name: Build release binary (cross-compile)
        if: matrix.use_cross == true
        run: cross build --release --target ${{ matrix.target }} --features cli
        working-directory: sea-core

      - name: Resolve CLI binary path
        if: matrix.os != 'windows-latest'
        run: |
          CLI_BIN=$(python3 scripts/resolve_rust_binary.py --workspace "$(pwd)" --name sea --profile release --target-triple ${{ matrix.target }} --require-executable)
          echo "Resolved CLI binary: $CLI_BIN"
          echo "CLI_BIN=$CLI_BIN" >> "$GITHUB_ENV"

      - name: Resolve CLI binary path (windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          $workspace = (Get-Location).Path
          $cliBin = python scripts/resolve_rust_binary.py --workspace "$workspace" --name sea --profile release --target-triple ${{ matrix.target }} --require-executable
          Write-Host "Resolved CLI binary: $cliBin"
          "CLI_BIN=$cliBin" >> $env:GITHUB_ENV

      - name: Verify CLI binary executes
        if: matrix.use_cross != true
        run: just ci-verify-binary "${{ env.CLI_BIN }}"

      - name: Check CLI binary size
        run: just ci-check-binary-size "${{ env.CLI_BIN }}" "${{ env.CLI_MAX_BYTES }}"

      - name: Package artifacts
        run: |
          ARCHIVE="sea-core-${{ matrix.target }}"
          if [ "${{ matrix.os }}" = "windows-latest" ]; then
            ARCHIVE="${ARCHIVE}.zip"
          else
            ARCHIVE="${ARCHIVE}.tar.gz"
          fi
          just ci-package-binary "${{ env.CLI_BIN }}" "$ARCHIVE"
          echo "ARCHIVE_PATH=$ARCHIVE" >> "$GITHUB_ENV"
        shell: bash

      - name: Verify packaged archive
        if: matrix.use_cross != true
        run: just ci-verify-package "${{ env.ARCHIVE_PATH }}" "sea"

      - name: Check packaged artifact size
        run: just ci-check-package-size "${{ env.ARCHIVE_PATH }}" "${{ env.CLI_ARTIFACT_MAX_BYTES }}"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sea-core-${{ matrix.target }}
          path: ${{ env.ARCHIVE_PATH }}

  build-python-wheels:
    name: Build Python Wheels (${{ matrix.target }})
    strategy:
      fail-fast: false
      matrix:
        include:
          # x86_64 targets
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
          - target: x86_64-apple-darwin
            os: macos-14  # macos-13 retired Dec 2024
          - target: x86_64-pc-windows-msvc
            os: windows-latest
          # ARM targets
          - target: aarch64-apple-darwin
            os: macos-14
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-latest
            use_zig: true
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install maturin
        run: pip install maturin==1.10.1

      - name: Install Zig (for ARM Linux cross-compile)
        if: matrix.use_zig == true
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: 0.11.0

      - name: Build wheels (native)
        if: matrix.use_zig != true
        run: maturin build --release --features python --target ${{ matrix.target }} --out dist
        working-directory: sea-core

      - name: Build wheels (cross-compile with Zig)
        if: matrix.use_zig == true
        run: maturin build --release --features python --target ${{ matrix.target }} --out dist --zig -i python3.11
        working-directory: sea-core

      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-${{ matrix.target }}
          path: sea-core/dist/*.whl

  build-wasm-release:
    name: Build WASM Release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - name: Install just
        uses: extractions/setup-just@v2

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry/index
            ~/.cargo/registry/cache
            ~/.cargo/git/db
            target
          key: ${{ runner.os }}-${{ env.CACHE_VERSION }}-wasm-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-${{ env.CACHE_VERSION }}-wasm-

      - name: Install wasm-pack
        run: cargo install wasm-pack --locked

      - name: Build WASM
        run: |
          cd sea-core
          wasm-pack build --target web --release --features wasm

      - name: Check WASM bundle size
        run: |
          WASM_FILE="sea-core/pkg/sea_core_bg.wasm"
          python3 scripts/ci_tasks.py check-size --file "$WASM_FILE" --max-bytes "${{ env.WASM_MAX_BYTES }}" --label "WASM bundle"

      - name: Package WASM artifacts
        run: |
          cd sea-core/pkg
          tar czf ../../sea-core-wasm.tar.gz *

      - name: Upload WASM artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sea-core-wasm
          path: sea-core-wasm.tar.gz

  create-release:
    name: Create GitHub Release
    needs: [build-release, build-python-wheels, build-wasm-release]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List artifacts
        run: find artifacts -type f | head -50

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: artifacts/**/*
          draft: false
          prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
